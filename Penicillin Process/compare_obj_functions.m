function compare_obj_functions()

close all
clear
clc

% % obj = [  101.1684
% %   415.8848
% %    88.0765
% %   403.3298
% %   604.9766
% %   358.0579
% %   602.2698
% %   521.9112
% %   592.9878
% %   595.7106
% %   552.2686
% %   581.2610
% %   592.9572
% %   572.0370
% %   517.2285
% %   589.4597
% %   481.6493
% %   590.3733
% %   597.2880
% %   619.1188
% %   470.2053
% %   573.5390
% %   499.4797
% %   600.2692
% %   536.2003
% %   566.9164
% %   550.8462
% %   605.6758
% %   437.1974
% %   589.7911
% %   536.1905
% %   595.9256
% %   541.2480
% %   568.2821
% %   403.3450
% %   577.7494
% %   416.3265
% %   503.9336
% %   559.0055
% %   530.1472
% %   568.3365
% %   572.6621
% %   515.1557
% %   602.0797
% %   483.4171
% %   581.9748
% %   571.1527
% %   598.0417
% %   508.0876
% %   575.7586
% %   345.8330
% %   575.7527
% %   538.0585
% %   596.9376];
% % 
% % input = [  5.1000    0.0400
% %     0.1000    0.5400
% %     0.1000    0.0400
% %    31.8587    0.1728
% %    26.8587    0.6728
% %    26.8587    0.1728
% %    47.4338    0.1728
% %    37.9237    0.1728
% %    47.4908    0.1728
% %    46.9908    0.1728
% %    58.3437    0.1728
% %    46.2625    0.1728
% %    54.6946    0.1728
% %    49.1315    0.1728
% %    61.2811    0.1728
% %    50.0932    0.1728
% %    62.7499    0.1728
% %    51.3960    0.1728
% %    61.4061    0.1728
% %    52.1804    0.1728
% %    65.6875    0.1728
% %    54.1909    0.1728
% %    61.4802    0.1728
% %    52.1219    0.1728
% %    43.5938    0.1728
% %    54.7733    0.1728
% %    62.7498    0.1728
% %    51.4942    0.1728
% %    67.1562    0.1728
% %    55.2417    0.1728
% %    42.1250    0.1728
% %    52.9854    0.1728
% %    65.6875    0.1728
% %    54.4657    0.1728
% %    67.1562    0.1728
% %    56.1871    0.1728
% %    68.6249    0.1728
% %    56.6455    0.1728
% %    44.9190    0.1728
% %    39.8420    0.1728
% %    55.5491    0.1728
% %    45.1078    0.1728
% %    39.1875    0.1728
% %    50.2498    0.1728
% %    39.1875    0.1728
% %    50.3963    0.1728
% %    64.2187    0.1728
% %    52.8350    0.1728
% %    67.1562    0.1728
% %    54.6409    0.1728
% %    68.6248    0.1728
% %    56.8320    0.1728
% %    43.5938    0.1728
% %    55.7577    0.1728];
% % 
% % doe = [          0    5.1000    0.0400
% %          0    0.1000    0.5400
% %          0    0.1000    0.0400
% %          0   31.8587    0.1728
% %          0   26.8587    0.6728
% %          0   26.8587    0.1728
% %          0   47.4338    0.1728
% %          0   37.9237    0.1728
% %          0   47.4908    0.1728
% %          0   46.9908    0.1728
% %          0   58.3437    0.1728
% %          0   46.2625    0.1728
% %          0   54.6946    0.1728
% %          0   49.1315    0.1728
% %          1   61.2811    0.1728
% %          0   50.0932    0.1728
% %          0   62.7499    0.1728
% %          0   51.3960    0.1728
% %          0   61.4061    0.1728
% %          0   52.1804    0.1728
% %          0   65.6875    0.1728
% %          0   54.1909    0.1728
% %          1   61.4802    0.1728
% %          0   52.1219    0.1728
% %          1   43.5938    0.1728
% %          0   54.7733    0.1728
% %          1   62.7498    0.1728
% %          0   51.4942    0.1728
% %          0   67.1562    0.1728
% %     0   55.2417    0.1728
% %          1   42.1250    0.1728
% %     0   52.9854    0.1728
% %     0   65.6875    0.1728
% %     1   54.4657    0.1728
% %          0   67.1562    0.1728
% %     0  56.1871    0.1728
% %          0   68.6249    0.1728
% %     0   56.6455    0.1728
% %     1   44.9190    0.1728
% %          0   39.8420    0.1728
% %     0   55.5491    0.1728
% %     1   45.1078    0.1728
% %          1   39.1875    0.1728
% %     0   50.2498    0.1728
% %          0   39.1875    0.1728
% %     1   50.3963    0.1728
% %     0   64.2187    0.1728
% %     1   52.8350    0.1728
% %          0   67.1562    0.1728
% %     1.0000   54.6409    0.1728
% %          0   68.6248    0.1728
% %     1.0000   56.8320    0.1728
% %     0   43.5938    0.1728
% %     1.0000   55.7577    0.1728
% %     0   64.3262    0.1728
% %     1.0000   54.2159    0.1728];

%%

obj = [  108.3594
  409.4336
   87.3593
  563.2734
  558.6523
  511.6136
  530.1415
  587.6120
  604.8391
  597.0089
  564.8858
  571.6363
  539.7875
  589.2199
  586.1228
  582.6168
  575.0759
  604.5688
  498.8555
  594.7199
  548.2316
  571.5352
  498.3067
  592.7748
  636.1002
  604.6361
  570.7450
  575.9601
  486.3021
  565.1668];

input = [5.1000    0.0400
    0.1000    0.5400
    0.1000    0.0400
   41.0476    0.1728
   36.0476    0.6728
   36.0476    0.1728
   60.2812    0.1728
   48.9335    0.1728
   57.4012    0.1728
   49.8568    0.1728
   50.5395    0.1728
   53.8968    0.1728
   57.3417    0.1728
   49.8676    0.1728
   57.3437    0.1728
   50.2520    0.1728
   60.2812    0.1728
   53.1732    0.1728
   61.7499    0.1728
   55.0789    0.1728
   63.2187    0.1728
   55.4071    0.1728
   64.6874    0.1728
   55.5284    0.1728
   63.2187    0.1728
   53.5552    0.1728
   46.5332    0.1728
   55.4144    0.1728
   66.1562    0.1728
   56.4165    0.1728];

doe = [       0    5.1000    0.0400
         0    0.1000    0.5400
         0    0.1000    0.0400
         0   41.0476    0.1728
         0   36.0476    0.6728
         0   36.0476    0.1728
    1.0000   60.2812    0.1728
    1.0000   48.9335    0.1728
    1.0000   57.4012    0.1728
    1.0000   49.8568    0.1728
    1.0000   50.5395    0.1728
    1.0000   53.8968    0.1728
    1.0000   57.3417    0.1728
    1.0000   49.8676    0.1728
    1.0000   57.3437    0.1728
    1.0000   50.2520    0.1728
    1.0000   60.2812    0.1728
    1.0000   53.1732    0.1728
    1.0000   61.7499    0.1728
    1.0000   55.0789    0.1728
    1.0000   63.2187    0.1728
    1.0000   55.4071    0.1728
         0   64.6874    0.1728
    1.0000   55.5284    0.1728
    0   63.2187    0.1728
    1.0000   53.5552    0.1728
    1.0000   46.5332    0.1728
    1.0000   55.4144    0.1728
         0   66.1562    0.1728
    1.0000   56.4165    0.1728
    1.0000   63.2187    0.1728
    1.0000   53.6973    0.1728];

%% new obj

obj = [   97.2584
  413.1023
   86.2965
  381.5630
  589.7796
  348.8748
  555.2897
  434.0526
  505.6032
  545.6818
  576.5751
  552.6573
  587.1429
  588.2971
  596.4009
  580.7116
  569.1946
  595.6812
  562.8902
  592.25
  542.0606
  565.9263
  526.0314
  589.2817
  564.2562
  583.0075
  543.2753
  595.0380];

input = [ 2.1000    0.0400
    0.1000    0.5400
    0.1000    0.0400
   31.1963    0.1728
   29.1963    0.6728
   29.1963    0.1728
   44.3250    0.1728
   33.4687    0.1728
   36.7500    0.1728
   40.5909    0.1728
   49.2000    0.1728
   42.0032    0.1728
   52.4500    0.1728
   45.0652    0.1728
   55.7000    0.1728
   47.9724    0.1728
   57.3250    0.1728
   49.5039    0.1728
   44.8750    0.1728
   53    0.1728
   43.2500    0.1728
   49.4090    0.1728
   60.5750    0.1728
   51.9180    0.1728
   60.5750    0.1728
   51.3881    0.1728
   40.0000    0.1728
   48.9767    0.1728];

doe = [         0    2.1000    0.0400
         0    0.1000    0.5400
         0    0.1000    0.0400
         0   31.1963    0.1728
         0   29.1963    0.6728
         0   29.1963    0.1728
         0   44.3250    0.1728
         0   33.4687    0.1728
         0   36.7500    0.1728
         0   40.5909    0.1728
         0   49.2000    0.1728
    1.0000   42.0032    0.1728
         0   52.4500    0.1728
    1.0000   45.0652    0.1728
         0   55.7000    0.1728
         0   47.9724    0.1728
    1.0000   57.3250    0.1728
         0   49.5039    0.1728
    1.0000   44.8750    0.1728
         1   53    0.1728
    1.0000   43.2500    0.1728
         0   49.4090    0.1728
    1.0000   60.5750    0.1728
         0   51.9180    0.1728
    1.0000   60.5750    0.1728
         0   51.3881    0.1728
    1.0000   40.0000    0.1728
         0   48.9767    0.1728
    1.0000   44.8750    0.1728
         0   50.6200    0.1728];

%%
% obj = [104.5242
%   418.5735
%    86.8511
%   541.9744
%   550.2193
%   524.1764
%   586.4709
%   541.9297
%   575.8749
%   529.3841
%   592.6133
%   577.6905
%   568.7123
%   582.0250
%   505.0153
%   575.7600
%   469.5239
%   570.8052
%   559.7581
%   576.9236
%   522.6560
%   608.4722
%   634.0673
%   574.9958
%   556.5224
%   585.3915
%   522.1947
%   606.0839
%   513.4139
%   596.4798
%   591.0968
%   581.6869
%   540.8602
%   611.9443
%   567.1760
%   589.9012
%   553.2763
%   568.6226
%   547.8056
%   578.3835
%   529.4966
%   610.9766
%   599.7231
%   566.6948
%   527.5500
%   566.5394
%   556.8707
%   570.8683
%   530.7590
%   586.7595
%   540.5494
%   550.5601
%   593.8711
%   495.4660
%   566.9846
%   600.4784];
% 
% input = [5.1000    0.0400
%     0.1000    0.5400
%     0.1000    0.0400
%    42.1296    0.1728
%    37.1296    0.6728
%    37.1296    0.1728
%    49.1663    0.1728
%    41.5395    0.1728
%    49.6940    0.1728
%    41.9497    0.1728
%    55.2757    0.1728
%    47.1771    0.1728
%    40.6563    0.1728
%    48.9915    0.1728
%    59.9812    0.1728
%    51.1297    0.1728
%    58.5124    0.1728
%    50.3226    0.1728
%    56.0808    0.1728
%    49.5738    0.1728
%    39.1876    0.1728
%    48.5438    0.1728
%    57.0433    0.1728
%    50.2672    0.1728
%    40.6563    0.1728
%    49.7383    0.1728
%    61.4499    0.1728
%    52.6123    0.1728
%    59.9812    0.1728
%    50.8159    0.1728
%    58.0598    0.1728
%    52.5867    0.1728
%    40.6563    0.1728
%    50.8391    0.1728
%    43.5938    0.1728
%    51.9517    0.1728
%    64.3873    0.1728
%    55.2608    0.1728
%    61.4645    0.1728
%    53.2997    0.1728
%    42.1250    0.1728
%    52.2041    0.1728
%    42.1251    0.1728
%    51.2312    0.1728
%    44.3875    0.1728
%    47.9594    0.1728
%    40.6563    0.1728
%    49.6992    0.1728
%    61.4500    0.1728
%    52.4820    0.1728
%    45.0625    0.1728
%    54.5227    0.1728
%    49.4688    0.1728
%    59.4555    0.1728
%    43.5938    0.1728
%    53.4312    0.1728];
% 
% doe = [         0    5.1000    0.0400
%          0    0.1000    0.5400
%          0    0.1000    0.0400
%          0   42.1296    0.1728
%          0   37.1296    0.6728
%          0   37.1296    0.1728
%          0   49.1663    0.1728
%          0   41.5395    0.1728
%          0   49.6940    0.1728
%          0   41.9497    0.1728
%          0   55.2757    0.1728
%          0   47.1771    0.1728
%          0   40.6563    0.1728
%          0   48.9915    0.1728
%          0   59.9812    0.1728
%          0   51.1297    0.1728
%          0   58.5124    0.1728
%          0   50.3226    0.1728
%          0   56.0808    0.1728
%          0   49.5738    0.1728
%          0   39.1876    0.1728
%          0   48.5438    0.1728
%          0   57.0433    0.1728
%          0   50.2672    0.1728
%          0   40.6563    0.1728
%          0   49.7383    0.1728
%          0   61.4499    0.1728
%          0   52.6123    0.1728
%          0   59.9812    0.1728
%          0   50.8159    0.1728
%          0   58.0598    0.1728
%          0   52.5867    0.1728
%          0   40.6563    0.1728
%     1.0000   50.8391    0.1728
%          0   43.5938    0.1728
%     1.0000   51.9517    0.1728
%          0   64.3873    0.1728
%     1.0000   55.2608    0.1728
%          0   61.4645    0.1728
%     1.0000   53.2997    0.1728
%          0   42.1250    0.1728
%     1.0000   52.2041    0.1728
%          0   42.1251    0.1728
%     1.0000   51.2312    0.1728
%          0   44.3875    0.1728
%     1.0000   47.9594    0.1728
%          0   40.6563    0.1728
%     1.0000   49.6992    0.1728
%     1.0000   61.4500    0.1728
%     1.0000   52.4820    0.1728
%          0   45.0625    0.1728
%     1.0000   54.5227    0.1728
%     1.0000   49.4688    0.1728
%     1.0000   59.4555    0.1728
%          0   43.5938    0.1728
%     1.0000   53.4312    0.1728
%     1.0000   61.4499    0.1728
%     1.0000   52.8746    0.1728];
%%
size(obj)
size(input)
size(doe)

model_para_doe = [0.1103	0.4078	0.0098	0.7949	0.0300	0.4682	0.9000	0.0167];
model_para_doe = [0.0982	0.4078	0.0071	0.7949	0.0300	0.4682	0.9000	0.0164];
% model_para_doe = [0.0869	0.4078	0.0065	0.7949	0.0300	0.4682	0.9000	0.0155];
% model_para_doe = [0.1320	0.4078	0.0196	0.7949	0.0300	0.4682	0.9000	0.0169]
model_para = [0.0853	0.4078	0.0167	0.7949	0.0300	0.4682	0.9000	0.0142];
model_para = [0.1002	0.4078	0.0295	0.7949	0.0300	0.4682	0.9000	0.0142];


%simulate process and plot objective function
%Define penicillin process simulator
pen_simulator = @penicillin_process_simulator;
%define process simulator
model = @penicillin_process_model;

%process parameters
K_process=[0.092 0.15 0.005 0.0002 0.1 0.04 0.45 0.9 0.014];

%Initial sampling time
sampling = [0:6:8*24];

%number of outputs
num_outputs = 4;

%list of output descriptions
list_output = {'biomass','penicillin','substrate','volume'};

%Initial substrate concentration
S0_initial = 0.1;

%Initial flowrate
F_initial = 0.1728;

%Initial volume
vol_initial = 100;

%Initial biomass
bio_initial = 0.1;

%Initial penicillin
pen_initial = 0;

%Initial process conditions
Y_initial = [bio_initial pen_initial S0_initial vol_initial];

sf_inlet = 600;
extra_var = sf_inlet; 

Y0 = Y_initial;
opt=odeset('RelTol',1e-6,'AbsTol',1e-8);    
    
S0_vec = [1:1:80];    
F_vec = [0.1728];
sf_nom = sf_inlet;
    i4 = 1;
    for i1 = S0_vec
%         
%         for i2 = F_vec


            U = [i1 0.1728];
            Y0(3) = U(1);
            
            [~, Y] = ode15s(pen_simulator,[sampling], Y0, opt,U,K_process,sf_nom);
            [~, Y_model_doe] = ode45(model,sampling, Y0, opt,U,model_para_doe,extra_var);
            [~, Y_model] = ode45(model,sampling, Y0, opt,U,model_para,extra_var);
            
            S=Y(end,2)*Y(end,4);
            S_model_doe=Y_model_doe(end,2)*Y_model_doe(end,4);
            S_model=Y_model(end,2)*Y_model(end,4);

            P_final_mat(i4) = S;
            P_final_model_doe(i4) = S_model_doe;
            P_final_model(i4) = S_model;

            i4 = i4 + 1;
%         end
%         disp('.');
%         i3 = i3 + 1;
    end
    
    P_final_model_doe = P_final_model_doe + P_final_mat(54) - P_final_model_doe(54);
    P_final_model = P_final_model + P_final_mat(54) - P_final_model(54);
    
    input2 = [];
    obj2 = [];
    
    figure(1)
    h1 = plot(S0_vec,-P_final_mat,'k','LineWidth',2);
    hold on
%     scatter(input(4:end,1),-obj(4:end))
    for i = 1:length(input(:,1))
        if doe(i,1) == 1
            h5 = scatter(input(i),-obj(i),50,'s','filled','MarkerFaceAlpha',.75,'MarkerFaceColor','r');
            input2 = [input2; input(i)];
            obj2 = [obj2; obj(i)];
        end
    end
    h2 = plot(S0_vec,-P_final_model_doe,'--r','LineWidth',2);
    h3 = plot(S0_vec,-P_final_model,':b','LineWidth',2);
    h4 = scatter([53 56],[-P_final_mat(54) -P_final_mat(54)+11],50,'b','filled','MarkerFaceAlpha',.75);
    xlabel('S_0')
    ylabel('P(t_f)')
    legend([h1 h2 h3 h5 h4],'Process cost function','Extended gradient correction with DoE',...
        'Local gradient correction','Measurements used in extended correction','Measurements used in local correction',...
        'Location','SouthWest')
    grid on;


%  S0_vec'
%  P_final_mat'
 P_final_model_doe'
%  P_final_model'
 
%  input2
%  obj2
%  input_wo = [53 56]'
%  obj_wo = [-P_final_mat(54) -P_final_mat(54)+11]'

end